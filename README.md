# 谷粒商城
## 谷粒商城——微服务架构图
![Image text](https://github.com/lzhharvey/picture/blob/master/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg
)

前后分离开发，分为内网部署和外网部署，外网是面向公众访问的，部署前端项目，可以有手机APP，电脑网页；内网部署的是后端集群，前端在页面上操作发送请求到后端，在这途中会经过Nginx集群，Nginx把请求转交给API网关(springcloud gateway)（网关可以根据当前请求动态地路由到指定的服务，看当前请求是想调用商品服务还是购物车服务还是检索），从路由过来如果请求很多，可以负载均衡地调用商品服务器中一台（商品服务复制了多份），当商品服务器出现问题也可以在网关层面对服务进行熔断或降级（使用阿里的sentinel组件），网关还有其他的功能如认证授权、限流（只放行部分到服务器）等。

到达服务器后进行处理（springboot为微服务），服务与服务可能会相互调用（使用feign组件），有些请求可能经过登录才能进行（基于OAuth2.0的认证中心。安全和权限使用springSecurity控制）

服务可能保存了一些数据或者需要使用缓存，我们使用redis集群（分片+哨兵集群）。持久化使用mysql，读写分离和分库分表。

服务和服务之间会使用消息队列（RabbitMQ），来完成异步解耦，分布式事务的一致性。有些服务可能需要全文检索，检索商品信息，使用ElaticSearch。

服务可能需要存取数据，使用阿里云的对象存储服务OSS。

项目上线后为了快速定位问题，使用ELK对日志进行处理，使用LogStash收集业务里的各种日志，把日志存储到ES中，用Kibana可视化页面从ES中检索出相关信息，帮助我们快速定位问题所在。

在分布式系统中，由于我们每个服务都可能部署在很多台机器，服务和服务可能相互调用，就得知道彼此都在哪里，所以需要将所有服务都注册到注册中心。服务从注册中心发现其他服务所在位置（使用阿里Nacos作为注册中心）。

每个服务的配置众多，为了实现改一处配置相同配置就同步更改，就需要配置中心，也使用阿里的Nacos，服务从配置中心中动态取配置。

服务追踪，追踪服务调用链哪里出现问题，使用springcloud提供的Sleuth、Zipkin、Metrics，把每个服务的信息交给开源的Prometheus进行聚合分析，再由Grafana进行可视化展示，提供Prometheus提供的AlterManager实时得到服务的告警信息，以短信/邮件的方式告知服务开发人员。

还提供了持续集成和持续部署。项目发布起来后，因为微服务众多，每一个都打包部署到服务器太麻烦，有了持续集成后开发人员可以将修改后的代码提交到github，运维人员可以通过自动化工具Jenkins Pipeline将github中获取的代码打包成docker镜像，最终是由k8s集成docker服务，将服务以docker容器的方式运行。

## 项目背景
### 电商模式
市面上有5种常见的电商模式B2B,B2C,C2B,C2C,O2O;  
1、B2B模式  
是指商家与商家建立的商业关系。如：阿里巴巴  
2、B2C模式  
就是我们经常看到的供应商直接把商品卖给用户，即商家对客户模式，也就是通常说的商业零售，直接面向消费者销售产品和服务。  
如：苏宁易购，京东，天猫，小米商城  
3、C2B模式  
即消费者对企业。先有消费者需求产生而后有企业生产，即先有消费者提出需求，后有生产生产企业按需求组织生产  
4、C2C模式
客户之间自己把东西放到网上去卖，如：淘宝，咸鱼  
5、O2O模式
即将线下商务的机会与互联网结合在一起，让互联网成为线下交易的前台。线上快速支付，线下优质服务。如：饿了么，美团  

谷粒商城是个B2C模式的电商平台，销售自营商品给客户。  

## 项目技术&特色
* 前后端分离开发，并开发基于vue的后台管理系统
* SpringtCloud全新的解决方案
* 应用监控、限流、网关、熔断降级等分布式方案，全方位涉及
* 解决分布式事务，分布式锁等分布式系统的难点
* 分析高并发场景的编码方式，线程池，异步编排等使用
* 压力测试与性能优化
* 各种集群技术的区别以及使用
* CI/CD使用
* ...

## 项目前置要求
* 熟悉springboot以及常见整合方案
* 了解SpringtCloud
* 熟悉git,maven
* 熟悉linux.redis.docker等基本操作
* 了解html,css,js,vue
* 熟悉使用idea开发项目

## 分布式基础概念
### 微服务
简而言之:微服务就是拒绝单体应用，基于业务边界进行服务微化拆分，各个服务独立部署运行  
### 集群&分布式&节点
* 集群是个物理形态，分布式是个工作方式。  
* 集群指的是将几台服务器集中在一起，实现同一业务。  
* 分布式是指将不同的业务分布在不同的地方。  
* 节点指的是集群中的每一个服务器

例如:京东是一个分布式系统，众多的业务运行在不同的机器，所有业务构成一个大型的业务集群。每一个小的业务，比如用户系统，访问压力大的时候一个服务器是不够的
。我们就将用户系统部署到多台服务器上，也就是每一个业务系统可以做集群化。  
分布式系统的每一个节点，都可以做集群。而集群并不一定就是分布式的。

### 远程调用
在分布式系统中，各个服务可能处于不同主机，但是服务之间不可避免的相互调用，我们称为远程调用  
springcloud中使用HTTP+JSON的方式完成远程调用  
![Image text](https://raw.githubusercontent.com/lzhharvey/picture/master/%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8.bmp)
## 负载均衡
![Image text](https://raw.githubusercontent.com/lzhharvey/picture/master/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.bmp)
## 服务注册/发现&注册中心
![Image text](https://raw.githubusercontent.com/lzhharvey/picture/master/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83.bmp)
## 配置中心
![Image text](https://raw.githubusercontent.com/lzhharvey/picture/master/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83.bmp)
## 服务熔断&降级
在微服务架构中，微服务之间通过网络进行通，存在相互依赖，当其中一个服务不可用时，有可能造成雪崩效应，要防止这样的情况，必须有容错机制来保护服务。
* 服务熔断：设置服务的超时，当被调用的服务经常失败到达某个阈值，我们可以开启断路保护机制，后来的请求不再去调用这个服务。本地直接返回默认的数据。
* 服务降级：在运维期间，当系统处于高峰期，系统资源紧张，我们可以让非核心业务降级运行。降级：某些服务不处理，或者处理简单【抛异常、返回NULL、调用Mock数据、调用Fallback处理逻辑】
## API网关
![Image text](https://raw.githubusercontent.com/lzhharvey/picture/master/%E7%BD%91%E5%85%B3.bmp)

